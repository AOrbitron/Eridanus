"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{10163:function(Ue,se,a){a.r(se),a.d(se,{default:function(){return Be}});var pe=a(97857),W=a.n(pe),he=a(19632),T=a.n(he),ge=a(15009),Z=a.n(ge),Se=a(64599),ue=a.n(Se),ye=a(99289),le=a.n(ye),me=a(5574),k=a.n(me),m=a(67294),j=a(2453),de=a(74330),xe=a(4393),je=a(83622),ce=a(16596),Ce=a(76654),Me=a(45311),Fe=a(39559),H={container:"container___h48jj",chatCard:"chatCard___Gvfnw",chatContainer:"chatContainer___JSUGd",message:"message___LqdX4",userMessage:"userMessage____4aef",serverMessage:"serverMessage___qvzZu",bottomTools:"bottomTools___ITAsD",uploadButton:"uploadButton___EvFcs",sendButton:"sendButton___zQ6N0"},Te=a(76772),be=a(91439),Re=a(42075),we=a(9669),i=a(85893),Pe=function(d){var S=Typography.Text,g=Typography.Title,v=useState({name:"\u52A0\u8F7D\u4E2D...",artists:"",picUrl:""}),C=_slicedToArray(v,2),b=C[0],y=C[1],c=useState(!0),M=_slicedToArray(c,2),I=M[0],z=M[1],ne=useState(!1),A=_slicedToArray(ne,2),R=A[0],B=A[1];return useEffect(function(){var re=function(){var $=_asyncToGenerator(_regeneratorRuntime().mark(function V(){var L,Q,X,N,O,Y;return _regeneratorRuntime().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(l.prev=0,Q=(L=d.split("id=")[1])===null||L===void 0?void 0:L.split(".")[0],Q){l.next=5;break}return B(!0),l.abrupt("return");case 5:return l.next=7,axios.get("https://music.163.com/api/song/detail?ids=[".concat(Q,"]"));case 7:X=l.sent,N=X.data,N.code===200&&N.songs&&N.songs.length>0?(O=N.songs[0],Y=O.artists.map(function(ae){return ae.name}).join(", "),y({name:O.name,artists:Y,picUrl:O.album.picUrl})):B(!0),l.next=16;break;case 12:l.prev=12,l.t0=l.catch(0),console.error("\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25:",l.t0),B(!0);case 16:return l.prev=16,z(!1),l.finish(16);case 19:case"end":return l.stop()}},V,null,[[0,12,16,19]])}));return function(){return $.apply(this,arguments)}}();re()},[d]),_jsx(Card,{style:{width:300,marginTop:10},loading:I,children:!I&&!R?_jsxs("div",{style:{display:"flex",alignItems:"center"},children:[_jsx(Image,{src:b.picUrl,width:64,height:64,style:{borderRadius:"4px"},preview:!1}),_jsxs("div",{style:{marginLeft:12,flex:1},children:[_jsx(g,{level:5,style:{margin:0},children:b.name}),_jsx(S,{type:"secondary",children:b.artists}),_jsx("audio",{src:d,controls:!0,style:{width:"100%",marginTop:8}})]})]}):R?_jsxs("div",{children:[_jsx(S,{type:"danger",children:"\u65E0\u6CD5\u52A0\u8F7D\u97F3\u4E50\u4FE1\u606F"}),_jsx("audio",{src:d,controls:!0,style:{width:"100%",marginTop:8}})]}):null})},De=function(d,S){var g={image:(0,i.jsx)(be.Z,{src:d,style:{maxWidth:"150px",cursor:"pointer"}}),video:(0,i.jsx)("video",{src:d,controls:!0,style:{maxWidth:"300px"}}),record:(0,i.jsx)("audio",{src:d,controls:!0,style:{width:"200px"}}),node:(0,i.jsx)("div",{children:"[\u8F6C\u53D1\u6D88\u606F\uFF0C\u6682\u4E0D\u652F\u6301]"}),music:(0,i.jsx)("div",{children:"[\u97F3\u4E50\u5361\u7247\uFF0C\u6682\u4E0D\u652F\u6301]"}),text:null};return g[S]||(0,i.jsx)("div",{children:"\u4E0D\u652F\u6301\u7684\u5A92\u4F53\u7C7B\u578B"})},Ee=function(d){var S,g=d.content,v=d.url,C=d.type,b=d.loading,y=d.replyTo,c=(0,Te.useModel)("@@initialState"),M=c.initialState,I=c.setInitialState,z=M==null||(S=M.settings)===null||S===void 0?void 0:S.isDark;return(0,i.jsxs)("div",{children:[y!=null&&y.content?(0,i.jsx)("div",{style:{padding:"5px",backgroundColor:"#f0f0f0",borderRadius:"4px",marginBottom:"8px",fontSize:"12px",color:"#666"},children:(0,i.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:y.content.length>50?"".concat(y.content.substring(0,50),"..."):y.content})}):null,g?"".concat(g):"",b?(0,i.jsx)("div",{style:{padding:"10px",textAlign:"center"},children:(0,i.jsxs)(Re.Z,{children:[(0,i.jsx)(de.Z,{size:"small"}),(0,i.jsx)("span",{children:"\u52A0\u8F7D\u4E2D..."})]})}):v&&C!="text"?(0,i.jsx)("div",{children:De(v,C)}):""]})},We=Ee,Ze="/api/ws",Ie="",Ae=function(){var d=(0,m.useState)([]),S=k()(d,2),g=S[0],v=S[1],C=(0,m.useRef)([]),b=(0,m.useState)(null),y=k()(b,2),c=y[0],M=y[1],I=m.useState(!1),z=k()(I,2),ne=z[0],A=z[1],R=(0,m.useRef)(null),B=m.useRef(null),re=(0,m.useState)(""),$=k()(re,2),V=$[0],L=$[1],Q=function(){console.log("Current messages:",g),g.forEach(function(t,e){console.log("Message ".concat(e,":"),t)})};(0,m.useEffect)(function(){return A(!0),X(),function(){c&&c.close()}},[]),(0,m.useEffect)(function(){fe(),C.current=g},[g]);var X=function r(){var t=new WebSocket("".concat(Ze,"?auth_token=").concat(localStorage.getItem("auth_token")));t.onopen=function(){A(!1),j.ZP.success("WebSocket \u5DF2\u8FDE\u63A5\uFF01")},t.onmessage=function(e){O(e.data)},t.onclose=function(){window.location.pathname=="/chat"&&(A(!0),setTimeout(r,5e3))},t.onerror=function(e){j.ZP.error("WebSocket \u8FDE\u63A5\u9519\u8BEF")},M(t)},N=function(){var r=le()(Z()().mark(function t(e){var n,o,u,f;return Z()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(n=e.target.files,!(!n||n.length===0)){s.next=3;break}return s.abrupt("return");case 3:o=ue()(n),s.prev=4,f=Z()().mark(function p(){var h,x;return Z()().wrap(function(D){for(;;)switch(D.prev=D.next){case 0:h=u.value,x=new FileReader,x.onload=function(){var E=le()(Z()().mark(function U(F){var w,G,q,_,P;return Z()().wrap(function(ie){for(;;)switch(ie.prev=ie.next){case 0:console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210 (handleFileUpload)"),G=(w=F.target)===null||w===void 0?void 0:w.result,q=h.type,_=h.type.split("/")[0],c&&c.readyState===WebSocket.OPEN?(P={type:_,data:{file:G,mime:q}},c.send(JSON.stringify([P])),K("[".concat(h.name,"]"),Date.now())):j.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA");case 5:case"end":return ie.stop()}},U)}));return function(U){return E.apply(this,arguments)}}(),x.onerror=function(E){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF (handleFileUpload):",E),j.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},console.log("\u5F00\u59CB\u8BFB\u53D6\u6587\u4EF6:",h.name),x.readAsDataURL(h);case 6:case"end":return D.stop()}},p)}),o.s();case 7:if((u=o.n()).done){s.next=11;break}return s.delegateYield(f(),"t0",9);case 9:s.next=7;break;case 11:s.next=16;break;case 13:s.prev=13,s.t1=s.catch(4),o.e(s.t1);case 16:return s.prev=16,o.f(),s.finish(16);case 19:case"end":return s.stop()}},t,null,[[4,13,16,19]])}));return function(e){return r.apply(this,arguments)}}(),O=function(t){try{var e,n=JSON.parse(t);if(!((e=n.message)!==null&&e!==void 0&&e.params)){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",n);return}var o=n.message.params.message;if(!Array.isArray(o)){console.warn("\u6D88\u606F\u683C\u5F0F\u9519\u8BEF:",o);return}var u=Date.now(),f,J=[],s=!1,p,h,x=ue()(o),oe;try{for(x.s();!(oe=x.n()).done;){var D,E,U,F=oe.value;h=F.type;var w=(D=F.data)===null||D===void 0?void 0:D.text,G=(E=F.data)===null||E===void 0?void 0:E.id;if(p=(U=F.data)===null||U===void 0?void 0:U.file,h==="reply"){var q=Y(G);f={id:G,content:q};continue}else if(h==="text"&&w)J.push(w);else{if(s=!0,p){p="/api/chat/file?path=".concat(p),ve(u,p,h);var _=J.join(`
`).replace("[\u52A0\u8F7D\u4E2D...]","[\u52A0\u8F7D\u5931\u8D25]");Ne(u,_)}F.data.type=="163"&&(p="https://music.163.com/song/media/outer/url?id=".concat(F.data.id,".mp3"),ve(u,p,h))}}}catch(ee){x.e(ee)}finally{x.f()}var P=J.join(`
`);s?Le(u,P,p,h,f):f?ae(u,P,h,f):l(u,P)}catch(ee){l(1,"\u89E3\u6790\u670D\u52A1\u5668\u6D88\u606F\u5931\u8D25: "+ee),l(1,"[\u6D88\u606F\u683C\u5F0F\u65E0\u6548]")}},Y=function(t){var e=C.current.find(function(o){return o.id==t});if(console.log("\u56DE\u590D\u7684\u6D88\u606Fid:".concat(t,",\u5185\u5BB9:"),JSON.stringify(e,null,2)),e!=null&&e.content)return e==null?void 0:e.content;if(e!=null&&e.type){var n={image:"[\u56FE\u7247]",node:"[\u8F6C\u53D1\u6D88\u606F]",music:"[\u97F3\u4E50]",audio:"[\u8BED\u97F3]",video:"[\u89C6\u9891]",file:"[\u6587\u4EF6]"};return"[".concat(n[e.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},K=function(t,e){console.log("\u7528\u6237\u6D88\u606Fid:".concat(e,",\u5185\u5BB9:").concat(t)),v(function(n){return[].concat(T()(n),[{role:"end",content:t,id:e,type:"text"}])})},l=function(t,e){v(function(n){return[].concat(T()(n),[{role:"start",content:e,id:t,type:"text"}])})},ae=function(t,e,n,o){v(function(u){return[].concat(T()(u),[{role:"start",content:e,id:t,type:n,replyTo:o}])})},ze=function(t){v(function(e){return[].concat(T()(e),[{role:"start",loading:!0,id:t}])})},Le=function(t,e,n,o,u){v(function(f){return[].concat(T()(f),[{role:"start",content:e,url:n,type:o,id:t,replyTo:u}])})},Je=function(t,e,n,o,u){v(function(f){return[].concat(T()(f),[{role:"start",content:e,url:n,type:o,loading:!0,id:t,replyTo:u}])})},ve=function(t,e,n){v(function(o){return o.map(function(u){return u.id===t?W()(W()({},u),{},{url:e,type:n,loading:!1}):u})}),fe()},Ne=function(t,e){v(function(n){return n.map(function(o){return o.id===t?W()(W()({},o),{},{content:e,loading:!1,id:t}):o})})},Ge=function(t){v(function(e){return e.map(function(n){return n.id===t?W()(W()({},n),{},{content:"\u56FE\u7247\u52A0\u8F7D\u5931\u8D25",loading:!1,id:t}):n})})},ke=function(t){v(function(e){return[].concat(T()(e),[{role:"start",url:t}])})},fe=function(){R.current&&(R.current.scrollTop=R.current.scrollHeight)},Oe=function(t){if(t.trim())if(c&&c.readyState===WebSocket.OPEN){var e=Date.now();K(t,e),c.send(JSON.stringify({type:"text",id:e,isat:!0,data:{text:t}})),L(""),setTimeout(function(){},10)}else j.ZP.error("WebSocket \u672A\u8FDE\u63A5")};return(0,i.jsx)(de.Z,{spinning:ne,tip:"websocket\u8FDE\u63A5\u4E2D...",size:"large",children:(0,i.jsxs)(xe.Z,{className:H.chatCard,ref:B,children:[(0,i.jsx)("div",{className:H.chatContainer,ref:R,children:g.map(function(r,t){return(0,i.jsx)(Ce.Z,{placement:r.role,shape:"corner",className:H.message,messageRender:function(){return(0,i.jsx)(We,{content:r.content,url:r.url,type:r.type,loading:r.loading,replyTo:r.replyTo})}},t)})}),(0,i.jsx)(Me.Z,{placeholder:"\u8BF7\u8F93\u5165...",className:H.bottomTools,value:V,autoSize:!0,onChange:function(t){L(t)},onSubmit:function(t){Oe(t)},prefix:(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(Fe.Z,{beforeUpload:function(){return!1},onChange:function(t){if(!t.file.originFileObj){console.error("\u6587\u4EF6\u5BF9\u8C61\u4E0D\u5B58\u5728"),j.ZP.error("\u6587\u4EF6\u4E0A\u4F20\u5931\u8D25\uFF1A\u65E0\u6CD5\u83B7\u53D6\u6587\u4EF6");return}var e=t.file.originFileObj;console.log("\u6587\u4EF6\u4E0A\u4F20:",e.name,e.type);var n=new FileReader;n.onload=function(o){var u;console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210");var f=(u=o.target)===null||u===void 0?void 0:u.result,J=e.type,s=e.type.split("/")[0];if(c&&c.readyState===WebSocket.OPEN){var p;s==="image"?p={type:s,data:{url:f,file:e.name}}:s==="video"||s==="audio"?p={type:s,data:{file:f}}:p={type:"file",data:{name:e.name,content:f}},c.send(JSON.stringify(p)),K("[".concat(e.name,"]"),Date.now())}else j.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA")},n.onerror=function(o){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF:",o),j.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},n.readAsDataURL(e)},getDropContainer:function(){return B.current},maxCount:5,multiple:!0,showUploadList:!1,placeholder:{icon:(0,i.jsx)(ce.Z,{}),title:"\u677E\u5F00\u4E0A\u4F20",description:"\u652F\u6301\u6587\u4EF6\uFF1A\u56FE\u7247\u3001\u89C6\u9891\u3001\u97F3\u9891\u7B49"},children:(0,i.jsx)(je.ZP,{type:"text",icon:(0,i.jsx)(ce.Z,{})})})})})]})})},Be=Ae}}]);
