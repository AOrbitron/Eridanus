"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{10163:function(Oe,ie,a){a.r(ie),a.d(ie,{default:function(){return Ae}});var pe=a(97857),D=a.n(pe),he=a(19632),M=a.n(he),ge=a(15009),W=a.n(ge),ye=a(64599),ue=a.n(ye),Se=a(99289),le=a.n(Se),me=a(5574),I=a.n(me),m=a(67294),x=a(2453),de=a(74330),je=a(4393),xe=a(83622),ce=a(16596),Ce=a(76654),Me=a(45311),Te=a(39559),z={container:"container___h48jj",chatCard:"chatCard___Gvfnw",chatContainer:"chatContainer___JSUGd",message:"message___LqdX4",userMessage:"userMessage____4aef",serverMessage:"serverMessage___qvzZu",bottomTools:"bottomTools___ITAsD",uploadButton:"uploadButton___EvFcs",sendButton:"sendButton___zQ6N0"},be=a(91439),Fe=a(42075),we=a(9669),s=a(85893),Ue=function(d){var S=Typography.Text,g=Typography.Title,c=useState({name:"\u52A0\u8F7D\u4E2D...",artists:"",picUrl:""}),T=_slicedToArray(c,2),y=T[0],J=T[1],h=useState(!0),G=_slicedToArray(h,2),k=G[0],H=G[1],ne=useState(!1),E=_slicedToArray(ne,2),b=E[0],Z=E[1];return useEffect(function(){var te=function(){var V=_asyncToGenerator(_regeneratorRuntime().mark(function $(){var A,Q,X,B,L,Y;return _regeneratorRuntime().wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(l.prev=0,Q=(A=d.split("id=")[1])===null||A===void 0?void 0:A.split(".")[0],Q){l.next=5;break}return Z(!0),l.abrupt("return");case 5:return l.next=7,axios.get("https://music.163.com/api/song/detail?ids=[".concat(Q,"]"));case 7:X=l.sent,B=X.data,B.code===200&&B.songs&&B.songs.length>0?(L=B.songs[0],Y=L.artists.map(function(ae){return ae.name}).join(", "),J({name:L.name,artists:Y,picUrl:L.album.picUrl})):Z(!0),l.next=16;break;case 12:l.prev=12,l.t0=l.catch(0),console.error("\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25:",l.t0),Z(!0);case 16:return l.prev=16,H(!1),l.finish(16);case 19:case"end":return l.stop()}},$,null,[[0,12,16,19]])}));return function(){return V.apply(this,arguments)}}();te()},[d]),_jsx(Card,{style:{width:300,marginTop:10},loading:k,children:!k&&!b?_jsxs("div",{style:{display:"flex",alignItems:"center"},children:[_jsx(Image,{src:y.picUrl,width:64,height:64,style:{borderRadius:"4px"},preview:!1}),_jsxs("div",{style:{marginLeft:12,flex:1},children:[_jsx(g,{level:5,style:{margin:0},children:y.name}),_jsx(S,{type:"secondary",children:y.artists}),_jsx("audio",{src:d,controls:!0,style:{width:"100%",marginTop:8}})]})]}):b?_jsxs("div",{children:[_jsx(S,{type:"danger",children:"\u65E0\u6CD5\u52A0\u8F7D\u97F3\u4E50\u4FE1\u606F"}),_jsx("audio",{src:d,controls:!0,style:{width:"100%",marginTop:8}})]}):null})},Re=function(d,S){var g={image:(0,s.jsx)(be.Z,{src:d,style:{maxWidth:"150px",cursor:"pointer"}}),video:(0,s.jsx)("video",{src:d,controls:!0,style:{maxWidth:"300px"}}),record:(0,s.jsx)("audio",{src:d,controls:!0,style:{width:"200px"}}),node:(0,s.jsx)("div",{children:"[\u8F6C\u53D1\u6D88\u606F]"}),music:(0,s.jsx)("div",{children:"[\u97F3\u4E50\u5361\u7247]"}),text:null};return g[S]||(0,s.jsx)("div",{children:"\u4E0D\u652F\u6301\u7684\u5A92\u4F53\u7C7B\u578B"})},De=function(d){var S=d.content,g=d.url,c=d.type,T=d.loading,y=d.replyTo;return(0,s.jsxs)("div",{children:[y!=null&&y.content?(0,s.jsx)("div",{style:{padding:"5px",backgroundColor:"#f0f0f0",borderRadius:"4px",marginBottom:"8px",fontSize:"12px",color:"#666"},children:(0,s.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:y.content.length>50?"".concat(y.content.substring(0,50),"..."):y.content})}):null,S?"".concat(S):"",T?(0,s.jsx)("div",{style:{padding:"10px",textAlign:"center"},children:(0,s.jsxs)(Fe.Z,{children:[(0,s.jsx)(de.Z,{size:"small"}),(0,s.jsx)("span",{children:"\u52A0\u8F7D\u4E2D..."})]})}):g&&c!="text"?(0,s.jsx)("div",{children:Re(g,c)}):""]})},We=De,Ee="/api/ws",Pe="",Ze=function(){var d=(0,m.useState)([]),S=I()(d,2),g=S[0],c=S[1],T=(0,m.useRef)([]),y=(0,m.useState)(null),J=I()(y,2),h=J[0],G=J[1],k=m.useState(!1),H=I()(k,2),ne=H[0],E=H[1],b=(0,m.useRef)(null),Z=m.useRef(null),te=(0,m.useState)(""),V=I()(te,2),$=V[0],A=V[1],Q=function(){console.log("Current messages:",g),g.forEach(function(r,e){console.log("Message ".concat(e,":"),r)})};(0,m.useEffect)(function(){return E(!0),X(),function(){h&&h.close()}},[]),(0,m.useEffect)(function(){fe(),T.current=g},[g]);var X=function t(){var r=new WebSocket("".concat(Ee,"?auth_token=").concat(localStorage.getItem("auth_token")));r.onopen=function(){E(!1),x.ZP.success("WebSocket \u5DF2\u8FDE\u63A5\uFF01")},r.onmessage=function(e){L(e.data)},r.onclose=function(){window.location.pathname=="/chat"&&(E(!0),setTimeout(t,5e3))},r.onerror=function(e){x.ZP.error("WebSocket \u8FDE\u63A5\u9519\u8BEF")},G(r)},B=function(){var t=le()(W()().mark(function r(e){var n,o,u,v;return W()().wrap(function(i){for(;;)switch(i.prev=i.next){case 0:if(n=e.target.files,!(!n||n.length===0)){i.next=3;break}return i.abrupt("return");case 3:o=ue()(n),i.prev=4,v=W()().mark(function f(){var p,j;return W()().wrap(function(F){for(;;)switch(F.prev=F.next){case 0:p=u.value,j=new FileReader,j.onload=function(){var R=le()(W()().mark(function N(C){var O,P,q,_,w;return W()().wrap(function(se){for(;;)switch(se.prev=se.next){case 0:console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210 (handleFileUpload)"),P=(O=C.target)===null||O===void 0?void 0:O.result,q=p.type,_=p.type.split("/")[0],h&&h.readyState===WebSocket.OPEN?(w={type:_,data:{file:P,mime:q}},h.send(JSON.stringify([w])),K("[".concat(p.name,"]"),Date.now())):x.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA");case 5:case"end":return se.stop()}},N)}));return function(N){return R.apply(this,arguments)}}(),j.onerror=function(R){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF (handleFileUpload):",R),x.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},console.log("\u5F00\u59CB\u8BFB\u53D6\u6587\u4EF6:",p.name),j.readAsDataURL(p);case 6:case"end":return F.stop()}},f)}),o.s();case 7:if((u=o.n()).done){i.next=11;break}return i.delegateYield(v(),"t0",9);case 9:i.next=7;break;case 11:i.next=16;break;case 13:i.prev=13,i.t1=i.catch(4),o.e(i.t1);case 16:return i.prev=16,o.f(),i.finish(16);case 19:case"end":return i.stop()}},r,null,[[4,13,16,19]])}));return function(e){return t.apply(this,arguments)}}(),L=function(r){try{var e,n=JSON.parse(r);if(!((e=n.message)!==null&&e!==void 0&&e.params)){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",n);return}var o=n.message.params.message;if(!Array.isArray(o)){console.warn("\u6D88\u606F\u683C\u5F0F\u9519\u8BEF:",o);return}var u=Date.now(),v,U=[],i=!1,f,p,j=ue()(o),oe;try{for(j.s();!(oe=j.n()).done;){var F,R,N,C=oe.value;p=C.type;var O=(F=C.data)===null||F===void 0?void 0:F.text,P=(R=C.data)===null||R===void 0?void 0:R.id;if(f=(N=C.data)===null||N===void 0?void 0:N.file,p==="reply"){var q=Y(P);v={id:P,content:q};continue}else if(p==="text"&&O)U.push(O);else{if(i=!0,f){f="/api/chat/file?path=".concat(f),ve(u,f,p);var _=U.join(`
`).replace("[\u52A0\u8F7D\u4E2D...]","[\u52A0\u8F7D\u5931\u8D25]");Le(u,_)}C.data.type=="163"&&(f="https://music.163.com/song/media/outer/url?id=".concat(C.data.id,".mp3"),ve(u,f,p))}}}catch(ee){j.e(ee)}finally{j.f()}var w=U.join(`
`);i?Be(u,w,f,p,v):v?ae(u,w,p,v):l(u,w)}catch(ee){l(1,"\u89E3\u6790\u670D\u52A1\u5668\u6D88\u606F\u5931\u8D25: "+ee),l(1,"[\u6D88\u606F\u683C\u5F0F\u65E0\u6548]")}},Y=function(r){var e=T.current.find(function(o){return o.id==r});if(console.log("\u56DE\u590D\u7684\u6D88\u606Fid:".concat(r,",\u5185\u5BB9:"),JSON.stringify(e,null,2)),e!=null&&e.content)return e==null?void 0:e.content;if(e!=null&&e.type){var n={image:"[\u56FE\u7247]",node:"[\u8F6C\u53D1\u6D88\u606F]",music:"[\u97F3\u4E50]",audio:"[\u8BED\u97F3]",video:"[\u89C6\u9891]",file:"[\u6587\u4EF6]"};return"[".concat(n[e.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},K=function(r,e){console.log("\u7528\u6237\u6D88\u606Fid:".concat(e,",\u5185\u5BB9:").concat(r)),c(function(n){return[].concat(M()(n),[{role:"end",content:r,id:e,type:"text"}])})},l=function(r,e){c(function(n){return[].concat(M()(n),[{role:"start",content:e,id:r,type:"text"}])})},ae=function(r,e,n,o){c(function(u){return[].concat(M()(u),[{role:"start",content:e,id:r,type:n,replyTo:o}])})},Ie=function(r){c(function(e){return[].concat(M()(e),[{role:"start",loading:!0,id:r}])})},Be=function(r,e,n,o,u){c(function(v){return[].concat(M()(v),[{role:"start",content:e,url:n,type:o,id:r,replyTo:u}])})},ze=function(r,e,n,o,u){c(function(v){return[].concat(M()(v),[{role:"start",content:e,url:n,type:o,loading:!0,id:r,replyTo:u}])})},ve=function(r,e,n){c(function(o){return o.map(function(u){return u.id===r?D()(D()({},u),{},{url:e,type:n,loading:!1}):u})}),fe()},Le=function(r,e){c(function(n){return n.map(function(o){return o.id===r?D()(D()({},o),{},{content:e,loading:!1,id:r}):o})})},Je=function(r){c(function(e){return e.map(function(n){return n.id===r?D()(D()({},n),{},{content:"\u56FE\u7247\u52A0\u8F7D\u5931\u8D25",loading:!1,id:r}):n})})},Ge=function(r){c(function(e){return[].concat(M()(e),[{role:"start",url:r}])})},fe=function(){b.current&&(b.current.scrollTop=b.current.scrollHeight)},Ne=function(r){if(r.trim())if(h&&h.readyState===WebSocket.OPEN){var e=Date.now();K(r,e),h.send(JSON.stringify({type:"text",id:e,isat:!0,data:{text:r}})),A(""),setTimeout(function(){},10)}else x.ZP.error("WebSocket \u672A\u8FDE\u63A5")};return(0,s.jsx)(de.Z,{spinning:ne,tip:"websocket\u8FDE\u63A5\u4E2D...",size:"large",children:(0,s.jsxs)(je.Z,{className:z.chatCard,ref:Z,children:[(0,s.jsx)("div",{className:z.chatContainer,ref:b,children:g.map(function(t,r){return(0,s.jsx)(Ce.Z,{placement:t.role,shape:"corner",className:z.message,messageRender:function(){return(0,s.jsx)(We,{content:t.content,url:t.url,type:t.type,loading:t.loading,replyTo:t.replyTo})}},r)})}),(0,s.jsx)(Me.Z,{placeholder:"\u8BF7\u8F93\u5165...",className:z.bottomTools,value:$,autoSize:!0,onChange:function(r){A(r)},onSubmit:function(r){Ne(r)},prefix:(0,s.jsx)(s.Fragment,{children:(0,s.jsx)(Te.Z,{beforeUpload:function(){return!1},onChange:function(r){if(!r.file.originFileObj){console.error("\u6587\u4EF6\u5BF9\u8C61\u4E0D\u5B58\u5728"),x.ZP.error("\u6587\u4EF6\u4E0A\u4F20\u5931\u8D25\uFF1A\u65E0\u6CD5\u83B7\u53D6\u6587\u4EF6");return}var e=r.file.originFileObj;console.log("\u6587\u4EF6\u4E0A\u4F20:",e.name,e.type);var n=new FileReader;n.onload=function(o){var u;console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210");var v=(u=o.target)===null||u===void 0?void 0:u.result,U=e.type,i=e.type.split("/")[0];if(h&&h.readyState===WebSocket.OPEN){var f;i==="image"?f={type:i,data:{url:v,file:e.name}}:i==="video"||i==="audio"?f={type:i,data:{file:v}}:f={type:"file",data:{name:e.name,content:v}},h.send(JSON.stringify(f)),K("[".concat(e.name,"]"),Date.now())}else x.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA")},n.onerror=function(o){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF:",o),x.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},n.readAsDataURL(e)},getDropContainer:function(){return Z.current},maxCount:5,multiple:!0,showUploadList:!1,placeholder:{icon:(0,s.jsx)(ce.Z,{}),title:"\u677E\u5F00\u4E0A\u4F20",description:"\u652F\u6301\u6587\u4EF6\uFF1A\u56FE\u7247\u3001\u89C6\u9891\u3001\u97F3\u9891\u7B49"},children:(0,s.jsx)(xe.ZP,{type:"text",icon:(0,s.jsx)(ce.Z,{})})})})})]})})},Ae=Ze}}]);
