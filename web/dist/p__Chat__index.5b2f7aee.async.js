"use strict";(self.webpackChunkant_design_pro=self.webpackChunkant_design_pro||[]).push([[570],{28650:function(nt,pe,u){u.r(pe),u.d(pe,{default:function(){return Ke}});var Te=u(97857),O=u.n(Te),Ee=u(19632),Z=u.n(Ee),Fe=u(64599),ge=u.n(Fe),De=u(15009),w=u.n(De),Be=u(99289),q=u.n(Be),Ae=u(5574),P=u.n(Ae),T=u(67294),B=u(2453),ae=u(74330),he=u(4393),Ze=u(83622),me=u(16596),We=u(76654),ke=u(45311),Oe=u(73869),xe=u(76772),ye=u(71471),oe=u(2487),Le=u(95715),$e=u(42075),at=u(9669),n=u(85893),ot=function(r){var h=Typography.Text,v=Typography.Title,l=useState({name:"\u52A0\u8F7D\u4E2D...",artists:"",picUrl:""}),p=_slicedToArray(l,2),M=p[0],a=p[1],m=useState(!0),f=_slicedToArray(m,2),j=f[0],ee=f[1],G=useState(!1),b=_slicedToArray(G,2),te=b[0],J=b[1];return useEffect(function(){var re=function(){var ie=_asyncToGenerator(_regeneratorRuntime().mark(function L(){var H,$,ne,A,D,V;return _regeneratorRuntime().wrap(function(x){for(;;)switch(x.prev=x.next){case 0:if(x.prev=0,$=(H=r.split("id=")[1])===null||H===void 0?void 0:H.split(".")[0],$){x.next=5;break}return J(!0),x.abrupt("return");case 5:return x.next=7,axios.get("https://music.163.com/api/song/detail?ids=[".concat($,"]"));case 7:ne=x.sent,A=ne.data,A.code===200&&A.songs&&A.songs.length>0?(D=A.songs[0],V=D.artists.map(function(se){return se.name}).join(", "),a({name:D.name,artists:V,picUrl:D.album.picUrl})):J(!0),x.next=16;break;case 12:x.prev=12,x.t0=x.catch(0),console.error("\u83B7\u53D6\u97F3\u4E50\u4FE1\u606F\u5931\u8D25:",x.t0),J(!0);case 16:return x.prev=16,ee(!1),x.finish(16);case 19:case"end":return x.stop()}},L,null,[[0,12,16,19]])}));return function(){return ie.apply(this,arguments)}}();re()},[r]),_jsx(Card,{style:{width:300,marginTop:10},loading:j,children:!j&&!te?_jsxs("div",{style:{display:"flex",alignItems:"center"},children:[_jsx(Image,{src:M.picUrl,width:64,height:64,style:{borderRadius:"4px"},preview:!1}),_jsxs("div",{style:{marginLeft:12,flex:1},children:[_jsx(v,{level:5,style:{margin:0},children:M.name}),_jsx(h,{type:"secondary",children:M.artists}),_jsx("audio",{src:r,controls:!0,style:{width:"100%",marginTop:8}})]})]}):te?_jsxs("div",{children:[_jsx(h,{type:"danger",children:"\u65E0\u6CD5\u52A0\u8F7D\u97F3\u4E50\u4FE1\u606F"}),_jsx("audio",{src:r,controls:!0,style:{width:"100%",marginTop:8}})]}):null})},Se=function(r){var h=ye.Z.Text,v=ye.Z.Title;if(!r)return(0,n.jsx)("div",{children:"\u8F6C\u53D1\u6D88\u606F\u6570\u636E\u65E0\u6548"});var l=[],p="\u8F6C\u53D1\u6D88\u606F";return r.message&&r.message.params&&r.message.params.messages?(l=r.message.params.messages,l.length>0&&l[0].data&&l[0].data.nickname&&(p=l[0].data.nickname)):r.data&&r.data.content?(l=[{data:{content:r.data.content}}],r.data.nickname&&(p=r.data.nickname)):Array.isArray(r)&&(l=r),l.length===0?(0,n.jsx)("div",{children:"\u8F6C\u53D1\u6D88\u606F\u6570\u636E\u65E0\u6548"}):(0,n.jsx)(he.Z,{title:p,style:{marginTop:10,maxWidth:"100%",backgroundColor:"#f9f9f9"},size:"small",bordered:!0,children:(0,n.jsx)(oe.Z,{itemLayout:"vertical",dataSource:l,renderItem:function(a){if(a.type==="node"&&a.data){var m=a.data.content||[];return(0,n.jsxs)(oe.Z.Item,{children:[a.data.nickname&&(0,n.jsx)("div",{style:{fontWeight:"bold",marginBottom:"4px"},children:a.data.nickname}),m.map(function(f,j){return f.type==="text"&&f.data&&f.data.text?(0,n.jsx)("div",{style:{whiteSpace:"pre-wrap",fontSize:"14px"},children:f.data.text},j):null})]})}else if(a.type==="text"&&a.data&&a.data.text)return(0,n.jsx)(oe.Z.Item,{children:(0,n.jsx)("div",{style:{whiteSpace:"pre-wrap",fontSize:"14px"},children:a.data.text})});return null},split:!0})})},Ne=function(r,h,v){if(h==="node"&&v)return Se(v);var l={image:(0,n.jsx)(Le.Z,{src:r,style:{maxWidth:"150px",cursor:"pointer"}}),video:(0,n.jsx)("video",{src:r,controls:!0,style:{maxWidth:"300px"}}),record:(0,n.jsx)("audio",{src:r,controls:!0,style:{width:"200px"}}),node:v?Se(v):(0,n.jsx)("div",{children:"\u8F6C\u53D1\u6D88\u606F\u6570\u636E\u65E0\u6548"}),music:(0,n.jsx)("div",{children:"[\u97F3\u4E50\u5361\u7247\uFF0C\u6682\u4E0D\u652F\u6301]"}),text:null};return l[h]||(0,n.jsx)("div",{children:"\u4E0D\u652F\u6301\u7684\u5A92\u4F53\u7C7B\u578B"})},Ue=function(r){var h,v=r.content,l=r.url,p=r.type,M=r.loading,a=r.replyTo,m=r.nodeData,f=(0,xe.useModel)("@@initialState"),j=f.initialState,ee=f.setInitialState,G=j==null||(h=j.settings)===null||h===void 0?void 0:h.isDark;return(0,n.jsxs)("div",{children:[a!=null&&a.content?(0,n.jsx)("div",{style:{padding:"5px",backgroundColor:"#f0f0f0",borderRadius:"4px",marginBottom:"8px",fontSize:"12px",color:"#666"},children:(0,n.jsx)("div",{style:{borderLeft:"2px solid #1890ff",paddingLeft:"8px"},children:a.content.length>50?"".concat(a.content.substring(0,50),"..."):a.content})}):null,v?"".concat(v):"",M?(0,n.jsx)("div",{style:{padding:"10px",textAlign:"center"},children:(0,n.jsxs)($e.Z,{children:[(0,n.jsx)(ae.Z,{size:"small"}),(0,n.jsx)("span",{children:"\u52A0\u8F7D\u4E2D..."})]})}):l&&p!="text"?(0,n.jsx)("div",{children:Ne(l,p,m)}):""]})},Ie=Ue,ze="chatMessagesDB",Pe=1,_="messages",Ge=function(){return new Promise(function(r,h){var v=indexedDB.open(ze,Pe);v.onerror=function(l){console.error("\u6570\u636E\u5E93\u6253\u5F00\u5931\u8D25:",l),h("\u6570\u636E\u5E93\u6253\u5F00\u5931\u8D25")},v.onsuccess=function(l){var p=l.target.result;r(p)},v.onupgradeneeded=function(l){var p=l.target.result;p.objectStoreNames.contains(_)||p.createObjectStore(_,{keyPath:"id"})}})},Je=function(){var F=q()(w()().mark(function r(h){var v,l,p;return w()().wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,Ge();case 3:return v=a.sent,l=v.transaction([_],"readwrite"),p=l.objectStore(_),p.clear(),h.forEach(function(m){p.add(m)}),a.abrupt("return",new Promise(function(m,f){l.oncomplete=function(){v.close(),m()},l.onerror=function(j){console.error("\u4FDD\u5B58\u6D88\u606F\u5931\u8D25:",j),f("\u4FDD\u5B58\u6D88\u606F\u5931\u8D25")}}));case 11:throw a.prev=11,a.t0=a.catch(0),console.error("\u4FDD\u5B58\u6D88\u606F\u65F6\u51FA\u9519:",a.t0),a.t0;case 15:case"end":return a.stop()}},r,null,[[0,11]])}));return function(h){return F.apply(this,arguments)}}(),it=null,st=null,He="/api/ws",Ve="",Ye=function(){var r,h=(0,xe.useModel)("@@initialState"),v=h.initialState,l=h.setInitialState,p=v==null||(r=v.settings)===null||r===void 0?void 0:r.isDark,M=(0,T.useState)([]),a=P()(M,2),m=a[0],f=a[1],j=(0,T.useRef)([]),ee=(0,T.useState)(null),G=P()(ee,2),b=G[0],te=G[1],J=T.useState(!1),re=P()(J,2),ie=re[0],L=re[1],H=T.useState(!0),$=P()(H,2),ne=$[0],A=$[1],D=(0,T.useRef)(null),V=T.useRef(null),je=(0,T.useState)(""),x=P()(je,2),se=x[0],ue=x[1],ut=function(){console.log("Current messages:",m),m.forEach(function(t,e){console.log("Message ".concat(e,":"),t)})};(0,T.useEffect)(function(){var o=function(){var t=q()(w()().mark(function e(){return w()().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:A(!0);try{}catch(c){console.error("\u52A0\u8F7D\u5386\u53F2\u6D88\u606F\u5931\u8D25:",c)}finally{A(!1),L(!0),Qe()}case 2:case"end":return s.stop()}},e)}));return function(){return t.apply(this,arguments)}}();return o(),function(){b&&b.close()}},[]),(0,T.useEffect)(function(){we(),j.current=m,m.length>0&&Je(m).catch(function(o){console.error("\u4FDD\u5B58\u6D88\u606F\u5230IndexedDB\u5931\u8D25:",o)})},[m]);var Qe=function o(){var t=new WebSocket("".concat(Ve).concat(He,"?auth_token=").concat(localStorage.getItem("auth_token")));t.onopen=function(){L(!1),B.ZP.success("WebSocket \u5DF2\u8FDE\u63A5\uFF01")},t.onmessage=function(e){Xe(e.data)},t.onclose=function(){window.location.pathname=="/chat"&&(L(!0),setTimeout(o,5e3))},t.onerror=function(e){B.ZP.error("WebSocket \u8FDE\u63A5\u9519\u8BEF")},te(t)},lt=function(){var o=q()(w()().mark(function t(e){var i,s,c,g;return w()().wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(i=e.target.files,!(!i||i.length===0)){d.next=3;break}return d.abrupt("return");case 3:s=ge()(i),d.prev=4,g=w()().mark(function C(){var y,E;return w()().wrap(function(N){for(;;)switch(N.prev=N.next){case 0:y=c.value,E=new FileReader,E.onload=function(){var K=q()(w()().mark(function W(U){var k,I,z,R,Q;return w()().wrap(function(X){for(;;)switch(X.prev=X.next){case 0:console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210 (handleFileUpload)"),I=(k=U.target)===null||k===void 0?void 0:k.result,z=y.type,R=y.type.split("/")[0],b&&b.readyState===WebSocket.OPEN?(Q={type:R,data:{file:I,mime:z}},b.send(JSON.stringify([Q])),le("[".concat(y.name,"]"),Date.now())):B.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA");case 5:case"end":return X.stop()}},W)}));return function(W){return K.apply(this,arguments)}}(),E.onerror=function(K){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF (handleFileUpload):",K),B.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},console.log("\u5F00\u59CB\u8BFB\u53D6\u6587\u4EF6:",y.name),E.readAsDataURL(y);case 6:case"end":return N.stop()}},C)}),s.s();case 7:if((c=s.n()).done){d.next=11;break}return d.delegateYield(g(),"t0",9);case 9:d.next=7;break;case 11:d.next=16;break;case 13:d.prev=13,d.t1=d.catch(4),s.e(d.t1);case 16:return d.prev=16,s.f(),d.finish(16);case 19:case"end":return d.stop()}},t,null,[[4,13,16,19]])}));return function(e){return o.apply(this,arguments)}}(),Xe=function(t){try{var e,i=JSON.parse(t);if(!((e=i.message)!==null&&e!==void 0&&e.params)){console.warn("\u6536\u5230\u65E0\u6548\u6D88\u606F:",i);return}var s=i.message.params.message;if(!Array.isArray(s)){console.warn("\u6D88\u606F\u683C\u5F0F\u9519\u8BEF:",s);return}var c=Date.now(),g,S=[],d=!1,C,y,E,Y=ge()(s),N;try{var K=function(){var k,I,z,R=N.value;y=R.type;var Q=(k=R.data)===null||k===void 0?void 0:k.text,fe=(I=R.data)===null||I===void 0?void 0:I.id;if(C=(z=R.data)===null||z===void 0?void 0:z.file,y==="reply"){var X=qe(fe);return g={id:fe,content:X},1}else if(y==="node")E=R,d=!0,S.push("[\u8F6C\u53D1\u6D88\u606F]");else if(y==="text"&&Q)S.push(Q);else if(y&&y!=="text"&&(d=!0,S.length===0&&S.push("[\u52A0\u8F7D\u4E2D...]"),C&&(Me(c,S.join(`
`),"",y,g,E),setTimeout(function(){var ve="/api/chat/file?path=".concat(C);Ce(c,ve,y,E);var rt=S.join(`
`).replace("[\u52A0\u8F7D\u4E2D...]","");Re(c,rt)},500)),R.data&&R.data.type==="163")){var tt="https://music.163.com/song/media/outer/url?id=".concat(R.data.id,".mp3");Me(c,S.join(`
`),"","music",g),setTimeout(function(){Ce(c,tt,"music");var ve=S.join(`
`).replace("[\u52A0\u8F7D\u4E2D...]","");Re(c,ve)},500)}};for(Y.s();!(N=Y.n()).done;)K()}catch(U){Y.e(U)}finally{Y.f()}var W=S.join(`
`);d&&E?be(c,W,"","node",g,E):d?be(c,W,C||"",y||"",g):g?_e(c,W,y||"text",g):ce(c,W)}catch(U){ce(1,"\u89E3\u6790\u670D\u52A1\u5668\u6D88\u606F\u5931\u8D25: "+U),ce(1,"[\u6D88\u606F\u683C\u5F0F\u65E0\u6548]")}},qe=function(t){var e=j.current.find(function(s){return s.id==t});if(console.log("\u56DE\u590D\u7684\u6D88\u606Fid:".concat(t,",\u5185\u5BB9:"),JSON.stringify(e,null,2)),e!=null&&e.content)return e==null?void 0:e.content;if(e!=null&&e.type){var i={image:"[\u56FE\u7247]",node:"[\u8F6C\u53D1\u6D88\u606F]",music:"[\u97F3\u4E50]",audio:"[\u8BED\u97F3]",video:"[\u89C6\u9891]",file:"[\u6587\u4EF6]"};return"[".concat(i[e.type],"]")}return"\u539F\u6D88\u606F\u4E0D\u53EF\u7528"},le=function(t,e){console.log("\u7528\u6237\u6D88\u606Fid:".concat(e,",\u5185\u5BB9:").concat(t)),f(function(i){return[].concat(Z()(i),[{role:"end",content:t,id:e,type:"text"}])})},ce=function(t,e){f(function(i){return[].concat(Z()(i),[{role:"start",content:e,id:t,type:"text"}])})},_e=function(t,e,i,s){f(function(c){return[].concat(Z()(c),[{role:"start",content:e,id:t,type:i,replyTo:s}])})},ct=function(t){f(function(e){return[].concat(Z()(e),[{role:"start",loading:!0,id:t}])})},be=function(t,e,i,s,c,g){f(function(S){return[].concat(Z()(S),[{role:"start",content:e,url:i,type:s,id:t,replyTo:c,nodeData:g}])})},Me=function(t,e,i,s,c,g){f(function(S){return[].concat(Z()(S),[{role:"start",content:e,url:i,type:s,loading:!0,id:t,replyTo:c,nodeData:g}])})},Ce=function(t,e,i,s){f(function(c){return c.map(function(g){return g.id===t?O()(O()({},g),{},{url:e,type:i,loading:!1,nodeData:s}):g})}),we()},Re=function(t,e){f(function(i){return i.map(function(s){return s.id===t?O()(O()({},s),{},{content:e,loading:!1,id:t}):s})})},dt=function(t){f(function(e){return e.map(function(i){return i.id===t?O()(O()({},i),{},{content:"\u56FE\u7247\u52A0\u8F7D\u5931\u8D25",loading:!1,id:t}):i})})},ft=function(t){f(function(e){return[].concat(Z()(e),[{role:"start",url:t}])})},we=function(){D.current&&(D.current.scrollTop=D.current.scrollHeight)},et=function(t){if(t.trim())if(b&&b.readyState===WebSocket.OPEN){var e=Date.now();le(t,e),b.send(JSON.stringify({type:"text",id:e,isat:!0,data:{text:t}})),ue(""),setTimeout(function(){},10)}else B.ZP.error("WebSocket \u672A\u8FDE\u63A5")},de={container:{top:0,display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden"},chatCard:{width:"100%",height:"calc(100vh-100px)",display:"flex",flexDirection:"column"},chatContainer:{position:"relative",display:"flex",flexDirection:"column",padding:"8px",borderRadius:"10px",height:"auto",marginBottom:"60px",overflowY:"auto"},message:{borderRadius:"1px",wordWrap:"break-word",margin:"10px 0",position:"relative"},userMessage:{marginLeft:"20%",background:"#1890ff",color:"white",borderBottomRightRadius:"4px"},serverMessage:{marginRight:"20%",background:"#f0f0f0",color:"#333",borderBottomLeftRadius:"4px"},bottomTools:{position:"absolute",left:"0",bottom:"0px",backgroundColor:p?"#2e2e2e":"#fff",maxHeight:"90vh",overflowY:"auto"},uploadButton:{flexShrink:0},sendButton:{flexShrink:0}};return(0,n.jsx)(ae.Z,{spinning:ie,tip:"websocket\u8FDE\u63A5\u4E2D...",size:"large",children:(0,n.jsx)(he.Z,{style:{height:"calc(100vh - 100px)"},children:(0,n.jsxs)("div",{ref:V,style:{width:"100%",height:"calc(100vh - 100px)",display:"flex",flexDirection:"column"},children:[(0,n.jsx)("div",{style:de.chatContainer,ref:D,children:ne?(0,n.jsx)("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:(0,n.jsx)(ae.Z,{tip:"\u52A0\u8F7D\u5386\u53F2\u6D88\u606F\u4E2D...",size:"large"})}):m.map(function(o,t){return(0,n.jsx)(We.Z,{placement:o.role,shape:"corner",style:de.message,messageRender:function(){return(0,n.jsx)(Ie,{content:o.content,url:o.url,type:o.type,loading:o.loading,replyTo:o.replyTo,nodeData:o.nodeData})}},t)})}),(0,n.jsx)(ke.Z,{placeholder:"\u8BF7\u8F93\u5165...",style:de.bottomTools,value:se,autoSize:!0,onChange:function(t){ue(t)},onSubmit:function(t){ue(""),et(t)},prefix:(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(Oe.Z,{beforeUpload:function(){return!1},onChange:function(t){if(!t.file.originFileObj){console.error("\u6587\u4EF6\u5BF9\u8C61\u4E0D\u5B58\u5728"),B.ZP.error("\u6587\u4EF6\u4E0A\u4F20\u5931\u8D25\uFF1A\u65E0\u6CD5\u83B7\u53D6\u6587\u4EF6");return}var e=t.file.originFileObj;console.log("\u6587\u4EF6\u4E0A\u4F20:",e.name,e.type);var i=new FileReader;i.onload=function(s){var c;console.log("\u6587\u4EF6\u8BFB\u53D6\u5B8C\u6210");var g=(c=s.target)===null||c===void 0?void 0:c.result,S=e.type,d=e.type.split("/")[0];if(b&&b.readyState===WebSocket.OPEN){var C;d==="image"?C={type:d,data:{url:g,file:e.name}}:d==="video"||d==="audio"?C={type:d,data:{file:g}}:C={type:"file",data:{name:e.name,content:g}},b.send(JSON.stringify(C)),le("[".concat(e.name,"]"),Date.now())}else B.ZP.error("WebSocket \u8FDE\u63A5\u672A\u5C31\u7EEA")},i.onerror=function(s){console.error("\u6587\u4EF6\u8BFB\u53D6\u9519\u8BEF:",s),B.ZP.error("\u6587\u4EF6\u8BFB\u53D6\u5931\u8D25")},i.readAsDataURL(e)},getDropContainer:function(){return V.current},maxCount:5,multiple:!0,showUploadList:!1,placeholder:{icon:(0,n.jsx)(me.Z,{}),title:"\u677E\u5F00\u4E0A\u4F20",description:"\u5F53\u524D\u4EC5\u652F\u6301\u56FE\u7247"},children:(0,n.jsx)(Ze.ZP,{type:"text",icon:(0,n.jsx)(me.Z,{})})})})})]})},"aaaaa")})},Ke=Ye}}]);
